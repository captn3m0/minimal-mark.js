!function(global,factory){"object"==typeof exports&&"undefined"!=typeof module?module.exports=factory():"function"==typeof define&&define.amd?define(factory):global.Mark=factory()}(this,function(){"use strict";function _typeof(obj){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj})(obj)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,function(arg){arg=function(input,hint){if("object"!=typeof input||null===input)return input;var prim=input[Symbol.toPrimitive];if(void 0===prim)return("string"===hint?String:Number)(input);prim=prim.call(input,hint||"default");if("object"!=typeof prim)return prim;throw new TypeError("@@toPrimitive must return a primitive value.")}(arg,"string");return"symbol"==typeof arg?arg:String(arg)}(descriptor.key),descriptor)}}function _createClass(Constructor,protoProps,staticProps){protoProps&&_defineProperties(Constructor.prototype,protoProps),staticProps&&_defineProperties(Constructor,staticProps),Object.defineProperty(Constructor,"prototype",{writable:!1})}function _extends(){return(_extends=Object.assign?Object.assign.bind():function(target){for(var i=1;i<arguments.length;i++){var key,source=arguments[i];for(key in source)Object.prototype.hasOwnProperty.call(source,key)&&(target[key]=source[key])}return target}).apply(this,arguments)}var DOMIterator=function(){function DOMIterator(ctx){_classCallCheck(this,DOMIterator),this.ctx=ctx}return _createClass(DOMIterator,[{key:"getContexts",value:function(){var filteredCtx=[],ctx=void 0!==this.ctx&&this.ctx?NodeList.prototype.isPrototypeOf(this.ctx)?Array.prototype.slice.call(this.ctx):Array.isArray(this.ctx)?this.ctx:"string"==typeof this.ctx?Array.prototype.slice.call(document.querySelectorAll(this.ctx)):[this.ctx]:[];return ctx.forEach(function(ctx){var isDescendant=0<filteredCtx.filter(function(contexts){return contexts.contains(ctx)}).length;-1!==filteredCtx.indexOf(ctx)||isDescendant||filteredCtx.push(ctx)}),filteredCtx}},{key:"createIterator",value:function(ctx,whatToShow,filter){return document.createNodeIterator(ctx,whatToShow,filter,!1)}},{key:"getIteratorNode",value:function(itr){var prevNode=itr.previousNode(),itr=(null===prevNode||itr.nextNode())&&itr.nextNode();return{prevNode:prevNode,node:itr}}},{key:"iterateThroughNodes",value:function(whatToShow,ctx,eachCb,filterCb,doneCb){for(var _this$getIteratorNode,_this=this,itr=this.createIterator(ctx,whatToShow,filterCb),elements=[];_this$getIteratorNode=void 0,_this$getIteratorNode=_this.getIteratorNode(itr),_this$getIteratorNode.prevNode,_this$getIteratorNode=_this$getIteratorNode.node;)elements.push(_this$getIteratorNode);elements.forEach(function(node){eachCb(node)}),doneCb()}},{key:"forEachNode",value:function(whatToShow,each,filter){var _this2=this,done=3<arguments.length&&void 0!==arguments[3]?arguments[3]:function(){},contexts=this.getContexts(),open=contexts.length;open||done(),contexts.forEach(function(ctx){_this2.iterateThroughNodes(whatToShow,ctx,each,filter,function(){--open<=0&&done()})})}}],[{key:"matches",value:function(element,selector){var match,selector="string"==typeof selector?[selector]:selector,fn=element.matches||element.matchesSelector||element.msMatchesSelector||element.mozMatchesSelector||element.oMatchesSelector||element.webkitMatchesSelector;return!!fn&&(match=!1,selector.every(function(sel){return!fn.call(element,sel)||!(match=!0)}),match)}}]),DOMIterator}(),RegExpCreator=function(){function RegExpCreator(options){_classCallCheck(this,RegExpCreator),this.opt=_extends({},{caseSensitive:!1},options)}return _createClass(RegExpCreator,[{key:"create",value:function(str){return str=this.escapeStr(str),str=this.createMergedBlanksRegExp(str),str=this.createAccuracyRegExp(str),new RegExp(str,"gm".concat(this.opt.caseSensitive?"":"i"))}},{key:"sortByLength",value:function(arry){return arry.sort(function(a,b){return a.length===b.length?b<a?1:-1:b.length-a.length})}},{key:"escapeStr",value:function(str){return str.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")}},{key:"createMergedBlanksRegExp",value:function(str){return str.replace(/[\s]+/gim,"[\\s]+")}},{key:"createAccuracyRegExp",value:function(str){var _this=this,acc=this.opt.accuracy,acc=("string"==typeof acc||acc.value,"string"==typeof acc?[]:acc.limiters),lsJoin="";return acc.forEach(function(limiter){lsJoin+="|".concat(_this.escapeStr(limiter))}),"(^|\\s".concat(lsJoin,")(").concat(str,")(?=$|\\s").concat(lsJoin,")")}}]),RegExpCreator}(),Mark=function(){function Mark(ctx){_classCallCheck(this,Mark),this.ctx=ctx,this.ie=!1;ctx=window.navigator.userAgent;(-1<ctx.indexOf("MSIE")||-1<ctx.indexOf("Trident"))&&(this.ie=!0)}return _createClass(Mark,[{key:"opt",get:function(){return this._opt},set:function(val){this._opt=_extends({},{element:"",className:"",exclude:[],iframes:!1,iframesTimeout:5e3,separateWordSearch:!0,acrossElements:!1,ignoreGroups:0,each:function(){},noMatch:function(){},filter:function(){return!0},done:function(){},debug:!1,log:window.console},val)}},{key:"iterator",get:function(){return new DOMIterator(this.ctx)}},{key:"log",value:function(msg){var level=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"debug",log=this.opt.log;this.opt.debug&&"object"===_typeof(log)&&"function"==typeof log[level]&&log[level]("mark.js: ".concat(msg))}},{key:"getSeparatedKeywords",value:function(sv){var _this=this,stack=[];return sv.forEach(function(kw){_this.opt.separateWordSearch?kw.split(" ").forEach(function(kwSplitted){kwSplitted.trim()&&-1===stack.indexOf(kwSplitted)&&stack.push(kwSplitted)}):kw.trim()&&-1===stack.indexOf(kw)&&stack.push(kw)}),{keywords:stack.sort(function(a,b){return b.length-a.length}),length:stack.length}}},{key:"isNumeric",value:function(value){return Number(parseFloat(value))==value}},{key:"checkRanges",value:function(array){var stack,last,_this2=this;return Array.isArray(array)&&"[object Object]"===Object.prototype.toString.call(array[0])?(stack=[],last=0,array.sort(function(a,b){return a.start-b.start}).forEach(function(item){var _this2$callNoMatchOnI=_this2.callNoMatchOnInvalidRanges(item,last),start=_this2$callNoMatchOnI.start,end=_this2$callNoMatchOnI.end;_this2$callNoMatchOnI.valid&&(item.start=start,item.length=end-start,stack.push(item),last=end)}),stack):(this.log("markRanges() will only accept an array of objects"),this.opt.noMatch(array),[])}},{key:"callNoMatchOnInvalidRanges",value:function(range,last){var start,end,valid=!1;return range&&void 0!==range.start?(end=(start=parseInt(range.start,10))+parseInt(range.length,10),this.isNumeric(range.start)&&this.isNumeric(range.length)&&0<end-last&&0<end-start?valid=!0:(this.log("Ignoring invalid or overlapping range: "+"".concat(JSON.stringify(range))),this.opt.noMatch(range))):(this.log("Ignoring invalid range: ".concat(JSON.stringify(range))),this.opt.noMatch(range)),{start:start,end:end,valid:valid}}},{key:"checkWhitespaceRanges",value:function(range,originalLength,string){var valid=!0,max=string.length,originalLength=originalLength-max,originalLength=parseInt(range.start,10)-originalLength,end=(originalLength=max<originalLength?max:originalLength)+parseInt(range.length,10);return max<end&&this.log("End range automatically set to the max value of ".concat(end=max)),originalLength<0||end-originalLength<0||max<originalLength||max<end?(valid=!1,this.log("Invalid range: ".concat(JSON.stringify(range))),this.opt.noMatch(range)):""===string.substring(originalLength,end).replace(/\s+/g,"")&&(valid=!1,this.log("Skipping whitespace only range: "+JSON.stringify(range)),this.opt.noMatch(range)),{start:originalLength,end:end,valid:valid}}},{key:"getTextNodes",value:function(cb){var _this3=this,val="",nodes=[];this.iterator.forEachNode(NodeFilter.SHOW_TEXT,function(node){nodes.push({start:val.length,end:(val+=node.textContent).length,node:node})},function(node){return _this3.matchesExclude(node.parentNode)?NodeFilter.FILTER_REJECT:NodeFilter.FILTER_ACCEPT},function(){cb({value:val,nodes:nodes})})}},{key:"matchesExclude",value:function(el){return DOMIterator.matches(el,this.opt.exclude.concat(["script","style","title","head","html"]))}},{key:"wrapRangeInTextNode",value:function(node,start,end){var hEl=this.opt.element||"mark",node=node.splitText(start),end=node.splitText(end-start),start=document.createElement(hEl);return start.setAttribute("data-markjs","true"),this.opt.className&&start.setAttribute("class",this.opt.className),start.textContent=node.textContent,node.parentNode.replaceChild(start,node),end}},{key:"wrapRangeInMappedTextNode",value:function(dict,start,end,filterCb,eachCb){var _this4=this;dict.nodes.every(function(n,i){var sibl=dict.nodes[i+1];if(void 0===sibl||sibl.start>start){if(!filterCb(n.node))return!1;var sibl=start-n.start,e=(end>n.end?n.end:end)-n.start,startStr=dict.value.substr(0,n.start),endStr=dict.value.substr(e+n.start);if(n.node=_this4.wrapRangeInTextNode(n.node,sibl,e),dict.value=startStr+endStr,dict.nodes.forEach(function(k,j){i<=j&&(0<dict.nodes[j].start&&j!==i&&(dict.nodes[j].start-=e),dict.nodes[j].end-=e)}),end-=e,eachCb(n.node.previousSibling,n.start),!(end>n.end))return!1;start=n.end}return!0})}},{key:"wrapGroups",value:function(node,pos,len,eachCb){return eachCb((node=this.wrapRangeInTextNode(node,pos,pos+len)).previousSibling),node}},{key:"separateGroups",value:function(node,match,matchIdx,filterCb,eachCb){for(var matchLen=match.length,i=1;i<matchLen;i++){var pos=node.textContent.indexOf(match[i]);match[i]&&-1<pos&&filterCb(match[i],node)&&(node=this.wrapGroups(node,pos,match[i].length,eachCb))}return node}},{key:"wrapMatches",value:function(regex,ignoreGroups,filterCb,eachCb,endCb){var _this5=this,matchIdx=0===ignoreGroups?0:ignoreGroups+1;this.getTextNodes(function(dict){dict.nodes.forEach(function(node){var match;for(node=node.node;null!==(match=regex.exec(node.textContent))&&""!==match[matchIdx];){if(_this5.opt.separateGroups&&1!==match.length)node=_this5.separateGroups(node,match,matchIdx,filterCb,eachCb);else{if(!filterCb(match[matchIdx],node))continue;var pos=match.index;if(0!==matchIdx)for(var i=1;i<matchIdx;i++)pos+=match[i].length;node=_this5.wrapGroups(node,pos,match[matchIdx].length,eachCb)}regex.lastIndex=0}}),endCb()})}},{key:"wrapMatchesAcrossElements",value:function(regex,ignoreGroups,filterCb,eachCb,endCb){var _this6=this,matchIdx=0===ignoreGroups?0:ignoreGroups+1;this.getTextNodes(function(dict){for(var match;null!==(match=regex.exec(dict.value))&&""!==match[matchIdx];){var start=match.index;if(0!==matchIdx)for(var i=1;i<matchIdx;i++)start+=match[i].length;var end=start+match[matchIdx].length;_this6.wrapRangeInMappedTextNode(dict,start,end,function(node){return filterCb(match[matchIdx],node)},function(node,lastIndex){regex.lastIndex=lastIndex,eachCb(node)})}endCb()})}},{key:"wrapRangeFromIndex",value:function(ranges,filterCb,eachCb,endCb){var _this7=this;this.getTextNodes(function(dict){var originalLength=dict.value.length;ranges.forEach(function(range,counter){var _this7$checkWhitespac=_this7.checkWhitespaceRanges(range,originalLength,dict.value),start=_this7$checkWhitespac.start,end=_this7$checkWhitespac.end;_this7$checkWhitespac.valid&&_this7.wrapRangeInMappedTextNode(dict,start,end,function(node){return filterCb(node,range,dict.value.substring(start,end),counter)},function(node){eachCb(node,range)})}),endCb()})}},{key:"unwrapMatches",value:function(node){for(var parent=node.parentNode,docFrag=document.createDocumentFragment();node.firstChild;)docFrag.appendChild(node.removeChild(node.firstChild));parent.replaceChild(docFrag,node),this.ie?this.normalizeTextNode(parent):parent.normalize()}},{key:"normalizeTextNode",value:function(node){if(node){if(3===node.nodeType)for(;node.nextSibling&&3===node.nextSibling.nodeType;)node.nodeValue+=node.nextSibling.nodeValue,node.parentNode.removeChild(node.nextSibling);else this.normalizeTextNode(node.firstChild);this.normalizeTextNode(node.nextSibling)}}},{key:"markRegExp",value:function(regexp,opt){var _this8=this,totalMatches=(this.opt=opt,this.log('Searching with expression "'.concat(regexp,'"')),0),opt="wrapMatches";this[opt=this.opt.acrossElements?"wrapMatchesAcrossElements":opt](regexp,this.opt.ignoreGroups,function(match,node){return _this8.opt.filter(node,match,totalMatches)},function(element){totalMatches++,_this8.opt.each(element)},function(){0===totalMatches&&_this8.opt.noMatch(regexp),_this8.opt.done(totalMatches)})}},{key:"mark",value:function(sv,opt){function handler(kw){var regex=new RegExpCreator(_this9.opt).create(kw),matches=0;_this9.log('Searching with expression "'.concat(regex,'"')),_this9[fn](regex,1,function(term,node){return _this9.opt.filter(node,kw,totalMatches,matches)},function(element){matches++,totalMatches++,_this9.opt.each(element)},function(){0===matches&&_this9.opt.noMatch(kw),kwArr[kwArrLen-1]===kw?_this9.opt.done(totalMatches):handler(kwArr[kwArr.indexOf(kw)+1])})}var _this9=this,totalMatches=(this.opt=opt,0),fn="wrapMatches",opt=this.getSeparatedKeywords("string"==typeof sv?[sv]:sv),kwArr=opt.keywords,kwArrLen=opt.length;this.opt.acrossElements&&(fn="wrapMatchesAcrossElements"),0===kwArrLen?this.opt.done(totalMatches):handler(kwArr[0])}},{key:"markRanges",value:function(rawRanges,opt){var _this10=this,totalMatches=(this.opt=opt,0),opt=this.checkRanges(rawRanges);opt&&opt.length?(this.log("Starting to mark with the following ranges: "+JSON.stringify(opt)),this.wrapRangeFromIndex(opt,function(node,range,match,counter){return _this10.opt.filter(node,range,match,counter)},function(element,range){totalMatches++,_this10.opt.each(element,range)},function(){_this10.opt.done(totalMatches)})):this.opt.done(totalMatches)}},{key:"unmark",value:function(opt){var _this11=this,sel=(this.opt=opt,this.opt.element||"*");sel+="[data-markjs]",this.opt.className&&(sel+=".".concat(this.opt.className)),this.log('Removal selector "'.concat(sel,'"')),this.iterator.forEachNode(NodeFilter.SHOW_ELEMENT,function(node){_this11.unwrapMatches(node)},function(node){var matchesSel=DOMIterator.matches(node,sel),node=_this11.matchesExclude(node);return!matchesSel||node?NodeFilter.FILTER_REJECT:NodeFilter.FILTER_ACCEPT},this.opt.done)}}]),Mark}();return function(ctx){var _this=this,instance=new Mark(ctx);return this.mark=function(sv,opt){return instance.mark(sv,opt),_this},this.unmark=function(opt){return instance.unmark(opt),_this},this}});
